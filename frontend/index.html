<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Life Story Voice Journal</title>
  <style>
    :root {
      --bg: #0f0f0f;
      --panel: #161616;
      --muted: #b7b7b7;
      --accent: #5b8def;
      --accent-2: #6dd8b5;
      --border: #242424;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: #f5f5f5;
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }
    .container { width: 100%; max-width: 1100px; }
    h1 { margin: 0 0 6px; letter-spacing: 0.6px; }
    p { color: var(--muted); }
    .tabs { display: flex; gap: 10px; margin: 18px 0; flex-wrap: wrap; }
    .tab-btn {
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1a1a1a;
      color: #ddd;
      cursor: pointer;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #22304c, #1e283a);
      border-color: #2e3d5b;
      color: #fff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #222;
      color: #fff;
      cursor: pointer;
    }
    button.primary { background: var(--accent); border-color: var(--accent); color: #0b1221; font-weight: 600; }
    button[disabled] { opacity: 0.6; cursor: default; }
    #log {
      white-space: pre-wrap;
      margin-top: 10px;
      font-size: 14px;
      background: #0f1218;
      padding: 12px;
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid #1b2335;
    }
    #status { margin-top: 6px; font-style: italic; color: var(--muted); }
    .muted { color: var(--muted); }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      background: #1e2a3f;
      border: 1px solid #273654;
      color: #dfe6ff;
      border-radius: 999px;
      margin: 0 6px 6px 0;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.positive { background: #183324; color: #7be3a6; border: 1px solid #2b5b40; }
    .badge.neutral { background: #262626; color: #c7c7c7; border: 1px solid #3a3a3a; }
    .badge.negative { background: #3a1e1e; color: #f39a9a; border: 1px solid #5a2c2c; }
    .entry-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      background: #131313;
      margin-bottom: 10px;
    }
    .entry-header { display: flex; justify-content: space-between; gap: 8px; }
    .entry-body { margin-top: 8px; }
    .entry-meta { font-size: 12px; color: var(--muted); }
    .expand {
      cursor: pointer;
      color: var(--accent-2);
      font-size: 13px;
      margin-top: 6px;
      display: inline-block;
    }
    .chat-pane {
      background: #0f1218;
      border: 1px solid #1f2437;
      border-radius: 10px;
      padding: 12px;
      max-height: 320px;
      overflow-y: auto;
    }
    .bubble {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 12px;
      margin: 8px 0;
      line-height: 1.4;
    }
    .bubble.user { background: #203459; margin-left: auto; color: #e8f1ff; }
    .bubble.assistant { background: #1a1a1a; border: 1px solid #222; color: #e4e4e4; }
    .bubble-meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .chat-input { display: flex; gap: 10px; margin-top: 10px; }
    .chat-input textarea { flex: 1; min-height: 70px; background: #121212; color: #eee; border: 1px solid #222; border-radius: 8px; padding: 8px; }
    .chart { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    .sparkline { width: 100%; height: 90px; background: #11131a; border: 1px solid #1e2638; border-radius: 8px; padding: 8px; }
    .recap-card { border: 1px solid #1f2c44; border-radius: 10px; padding: 12px; background: #0f1218; margin-top: 10px; }
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; margin-top: 8px; }
    .stat { background:#0f1218; border:1px solid #1f2437; border-radius:8px; padding:10px; }
    .filter-btn.active { background: var(--accent); color: #0b1221; border-color: var(--accent); }
    textarea { width: 100%; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Life Story Voice Assistant</h1>
    <p>Capture memories, browse your timeline, and chat with insights grounded in your entries.</p>

    <div class="tabs">
      <button class="tab-btn active" data-tab="capture">Capture</button>
      <button class="tab-btn" data-tab="timeline">Timeline</button>
      <button class="tab-btn" data-tab="insights">Insights &amp; Chat</button>
    </div>

    <!-- Capture Tab -->
    <section id="capture" class="tab-content active">
      <div class="card">
        <h2>Record / Upload entry</h2>
        <p class="muted">Click <strong>Start Recording</strong>, tell a story, then click <strong>Stop &amp; Save</strong>. Audio is transcribed, analyzed, and stored.</p>
        <button id="startBtn" class="primary">ðŸŽ¤ Start Recording</button>
        <button id="stopBtn" disabled>ðŸ›‘ Stop &amp; Save</button>
        <div id="status">Not recording.</div>
        <div id="log"></div>
      </div>
      <div class="card">
        <h3>Recent entries</h3>
        <div id="recentEntries" class="muted">Loadingâ€¦</div>
      </div>
    </section>

    <!-- Timeline Tab -->
    <section id="timeline" class="tab-content">
      <div class="card">
        <h2>Browse your timeline</h2>
        <div style="margin-bottom:10px;">
          <button class="filter-btn" data-range="7" id="filter7">Last 7 days</button>
          <button class="filter-btn" data-range="30" id="filter30">Last 30 days</button>
          <button class="filter-btn active" data-range="all" id="filterAll">All time</button>
        </div>
        <div id="timelineStatus" class="muted">Loadingâ€¦</div>
        <div id="timelineList"></div>
      </div>
    </section>

    <!-- Insights & Chat Tab -->
    <section id="insights" class="tab-content">
      <div class="card">
        <h2>Insights</h2>
        <div id="summaryText" class="muted">Loading statsâ€¦</div>
        <div class="stat-grid">
          <div class="stat" id="statEntries"></div>
          <div class="stat" id="statWords"></div>
          <div class="stat" id="statAvg"></div>
        </div>
        <div id="entriesChart" class="chart"></div>
        <button id="weeklyQuickBtn" class="primary" style="margin-top:8px;">Generate weekly recap</button>
        <div id="weeklyQuickStatus" class="muted"></div>
        <div id="weeklyQuickResult" class="recap-card hidden"></div>
      </div>
      <div class="card">
        <h2>Chat with your memories</h2>
        <p class="muted">The assistant answers using only your stored entries.</p>
        <div id="chatPane" class="chat-pane"></div>
        <div class="chat-input">
          <textarea id="chatInput" placeholder="Ask something..."></textarea>
          <button id="chatSendBtn" class="primary">Send</button>
        </div>
        <div class="muted" id="chatStatus"></div>
      </div>
    </section>
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");
    const recentEntriesEl = document.getElementById("recentEntries");
    const timelineStatus = document.getElementById("timelineStatus");
    const timelineList = document.getElementById("timelineList");
    const summaryText = document.getElementById("summaryText");
    const entriesChart = document.getElementById("entriesChart");
    const statEntries = document.getElementById("statEntries");
    const statWords = document.getElementById("statWords");
    const statAvg = document.getElementById("statAvg");
    const weeklyQuickBtn = document.getElementById("weeklyQuickBtn");
    const weeklyQuickStatus = document.getElementById("weeklyQuickStatus");
    const weeklyQuickResult = document.getElementById("weeklyQuickResult");
    const chatPane = document.getElementById("chatPane");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatStatus = document.getElementById("chatStatus");

    const filter7 = document.getElementById("filter7");
    const filter30 = document.getElementById("filter30");
    const filterAll = document.getElementById("filterAll");

    let mediaRecorder = null;
    let chunks = [];
    let conversationHistory = [];
    let entriesCache = [];
    let summaryCache = null;

    // --- Tab logic ---
    function setActiveTab(tabName) {
      tabButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.tab === tabName));
      tabContents.forEach((section) => section.classList.toggle("active", section.id === tabName));

      if (tabName === "timeline" || tabName === "capture" || tabName === "insights") {
        loadEntries(); // shared cache
      }
      if (tabName === "insights") {
        loadSummary();
      }
    }
    tabButtons.forEach((btn) => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));

    // --- Capture (existing flow) ---
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          log("Recording stopped. Uploading entry to backendâ€¦");
          statusEl.textContent = "Uploading and processing entryâ€¦";
          const formData = new FormData();
          formData.append("file", blob, "entry.webm");

          try {
            const resp = await fetch("http://localhost:8000/entries", { method: "POST", body: formData });
            if (!resp.ok) {
              const text = await resp.text();
              log(`âŒ Server error: ${resp.status} â€“ ${text}`);
              statusEl.textContent = "Error uploading entry.";
              return;
            }
            await resp.json();
            log("âœ… Entry stored.");
            statusEl.textContent = "Entry saved successfully.";
            entriesCache = []; // force reload
            loadEntries();
            loadSummary();
          } catch (err) {
            console.error(err);
            log("âŒ Failed to upload entry: " + err.message);
            statusEl.textContent = "Upload failed.";
          }
        };

        mediaRecorder.start();
        statusEl.textContent = "Recordingâ€¦ tell your story.";
        log("ðŸŽ™ Recording started.");
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error(err);
        log("âŒ Could not start recording: " + err.message);
        statusEl.textContent = "Microphone access failed.";
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }
    startBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);

    // --- Data fetching ---
    async function loadEntries() {
      if (entriesCache.length) {
        renderRecent(entriesCache);
        renderTimeline(entriesCache, "all");
        return;
      }
      timelineStatus.textContent = "Loadingâ€¦";
      try {
        const resp = await fetch("http://localhost:8000/insights/entries");
        if (!resp.ok) throw new Error(`Server responded with ${resp.status}`);
        entriesCache = await resp.json();
        renderRecent(entriesCache);
        renderTimeline(entriesCache, "all");
      } catch (err) {
        recentEntriesEl.textContent = `Failed to load entries: ${err.message}`;
        timelineStatus.textContent = `Failed to load entries: ${err.message}`;
      }
    }

    async function loadSummary() {
      if (summaryCache) {
        renderSummary(summaryCache);
        return;
      }
      summaryText.textContent = "Loading statsâ€¦";
      entriesChart.innerHTML = "";
      try {
        const resp = await fetch("http://localhost:8000/insights/summary");
        if (!resp.ok) throw new Error(`Server responded with ${resp.status}`);
        summaryCache = await resp.json();
        renderSummary(summaryCache);
      } catch (err) {
        summaryText.textContent = `Failed to load stats: ${err.message}`;
      }
    }

    // --- Recent entries (Capture tab) ---
    function renderRecent(entries) {
      if (!entries || !entries.length) {
        recentEntriesEl.textContent = "No entries yet.";
        return;
      }
      const topThree = entries.slice(0, 3);
      recentEntriesEl.innerHTML = topThree.map((e) => {
        const date = new Date(e.created_at).toLocaleString();
        return `<div class="entry-card"><div class="entry-header"><div>${date}</div></div><div class="entry-body">${e.summary || e.preview || "â€”"}</div></div>`;
      }).join("");
    }

    // --- Timeline ---
    [filter7, filter30, filterAll].forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        renderTimeline(entriesCache, btn.dataset.range || "all");
      });
    });

    function renderTimeline(entries, range = "all") {
      timelineList.innerHTML = "";
      if (!entries || !entries.length) {
        timelineStatus.textContent = "No entries yet.";
        return;
      }
      timelineStatus.textContent = "";
      const now = Date.now();
      const filtered = entries.filter((e) => {
        if (range === "all") return true;
        const days = parseInt(range, 10);
        const diff = (now - new Date(e.created_at).getTime()) / (1000 * 60 * 60 * 24);
        return diff <= days;
      });

      if (!filtered.length) {
        timelineStatus.textContent = "No entries in this range.";
        return;
      }

      filtered.forEach((entry, idx) => {
        const card = document.createElement("div");
        card.className = "entry-card";
        const dateStr = new Date(entry.created_at).toLocaleString();
        const sentimentClass = entry.sentiment_label ? entry.sentiment_label.toLowerCase() : "neutral";
        const sentimentBadge = entry.sentiment_label
          ? `<span class="badge ${sentimentClass}">${entry.sentiment_label}${entry.sentiment_score ? ` (${Math.round(entry.sentiment_score * 100)}%)` : ""}</span>`
          : "";

        card.innerHTML = `
          <div class="entry-header">
            <div><strong>${dateStr}</strong></div>
            <div>${sentimentBadge}</div>
          </div>
          <div class="entry-body">
            <div>${entry.summary || entry.preview || "â€”"}</div>
            <div style="margin-top:6px;">${(entry.topics || []).map((t) => `<span class="pill">${t}</span>`).join("") || '<span class="muted">No topics</span>'}</div>
            <div class="expand" data-idx="${idx}">Toggle details</div>
            <div class="entry-meta hidden" id="meta-${idx}">
              <div><strong>Full text:</strong> ${entry.preview || "â€”"}</div>
              <div><strong>People/Places:</strong> ${(entry.people || []).join(", ") || "â€”"} / ${(entry.places || []).join(", ") || "â€”"}</div>
              <div><strong>Word count:</strong> ${entry.word_count ?? "-"}</div>
            </div>
          </div>
        `;
        card.querySelector(".expand").addEventListener("click", () => {
          const meta = document.getElementById(`meta-${idx}`);
          meta.classList.toggle("hidden");
        });
        timelineList.appendChild(card);
      });
    }

    // --- Insights summary & chart ---
    function renderSummary(data) {
      if (!data) {
        summaryText.textContent = "No data available.";
        return;
      }
      const { total_entries, total_words, average_word_count, entries_per_day } = data;
      summaryText.textContent = "Your entries at a glance:";
      statEntries.textContent = `Entries: ${total_entries}`;
      statWords.textContent = `Total words: ${total_words}`;
      statAvg.textContent = `Avg words/entry: ${average_word_count.toFixed(1)}`;

      entriesChart.innerHTML = "";
      const spark = renderSparkline(entries_per_day || []);
      entriesChart.appendChild(spark);
    }

    function renderSparkline(points) {
      const wrap = document.createElement("div");
      wrap.className = "sparkline";

      if (!points.length) {
        wrap.textContent = "No entries per-day data yet.";
        return wrap;
      }

      // Use last 30 days max to avoid massive charts
      const recent = points.slice(-30);
      const maxCount = Math.max(...recent.map((p) => p.count), 1);
      const width = 600;
      const height = 60;

      const svgParts = [];
      recent.forEach((p, idx) => {
        const x = (idx / Math.max(recent.length - 1, 1)) * width;
        const y = height - (p.count / maxCount) * height;
        svgParts.push({ x, y, count: p.count, date: p.date });
      });

      const pathD = svgParts.map((pt, i) => `${i === 0 ? "M" : "L"}${pt.x},${pt.y}`).join(" ");
      const circles = svgParts
        .map((pt) => `<circle cx="${pt.x}" cy="${pt.y}" r="3" fill="${pt.count === maxCount ? "#6dd8b5" : "#5b8def"}"><title>${pt.date}: ${pt.count}</title></circle>`)
        .join("");

      wrap.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%;height:60px;">
          <path d="${pathD}" fill="none" stroke="url(#grad)" stroke-width="2" />
          ${circles}
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#5b8def" />
              <stop offset="100%" stop-color="#6dd8b5" />
            </linearGradient>
          </defs>
        </svg>
        <div class="muted" style="font-size:12px;margin-top:4px;">Last ${recent.length} days â€¢ Peak: ${maxCount} entr${maxCount === 1 ? "y" : "ies"} in a day</div>
      `;
      return wrap;
    }

    // --- Weekly recap (simple card) ---
    async function generateWeeklyQuick() {
      weeklyQuickStatus.textContent = "Generating...";
      weeklyQuickResult.classList.add("hidden");
      weeklyQuickResult.innerHTML = "";
      weeklyQuickBtn.disabled = true;
      try {
        const resp = await fetch("http://localhost:8000/insights/weekly");
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        const data = await resp.json();
        weeklyQuickResult.classList.remove("hidden");
        weeklyQuickResult.innerHTML = `
          <div class="muted">Entries: ${data.total_entries ?? "â€”"} â€¢ Avg sentiment: ${data.average_sentiment ?? "â€”"}</div>
          <div><strong>Summary:</strong> ${data.summary || "â€”"}</div>
          <div style="margin-top:6px;"><strong>Top topics:</strong> ${(data.top_topics || []).join(", ") || "â€”"}</div>
        `;
        weeklyQuickStatus.textContent = "";
      } catch (err) {
        weeklyQuickStatus.textContent = `Error: ${err.message || "Weekly recap unavailable"}`;
        // TODO: handle missing /insights/weekly endpoint or upstream failures more gracefully
      } finally {
        weeklyQuickBtn.disabled = false;
      }
    }
    weeklyQuickBtn.addEventListener("click", generateWeeklyQuick);

    // --- Chat ---
    async function sendConversationMessage() {
      const text = chatInput.value.trim();
      if (!text) {
        chatStatus.textContent = "Please enter a message.";
        return;
      }
      chatStatus.textContent = "Thinkingâ€¦";
      chatSendBtn.disabled = true;

      conversationHistory.push({ role: "user", content: text });
      renderConversation();
      chatInput.value = "";

      try {
        const resp = await fetch("http://localhost:8000/conversation/respond", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: conversationHistory }),
        });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        conversationHistory.push({
          role: "assistant",
          content: data.response || "No response.",
          used_entry_ids: data.used_entry_ids || [],
        });
        renderConversation();
        chatStatus.textContent = data.used_entry_ids?.length
          ? `Based on ${data.used_entry_ids.length} entr${data.used_entry_ids.length === 1 ? "y" : "ies"}.`
          : "";
      } catch (err) {
        chatStatus.textContent = `Error: ${err.message}`;
      } finally {
        chatSendBtn.disabled = false;
      }
    }
    chatSendBtn.addEventListener("click", sendConversationMessage);

    function renderConversation() {
      chatPane.innerHTML = "";
      conversationHistory.forEach((turn) => {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${turn.role}`;
        bubble.textContent = turn.content;
        chatPane.appendChild(bubble);
        if (turn.role === "assistant" && turn.used_entry_ids && turn.used_entry_ids.length) {
          const meta = document.createElement("div");
          meta.className = "bubble-meta";
          meta.textContent = `Based on ${turn.used_entry_ids.length} entr${turn.used_entry_ids.length === 1 ? "y" : "ies"}.`;
          chatPane.appendChild(meta);
        }
      });
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    // Initial load
    setActiveTab("capture");
  </script>
</body>
</html>
