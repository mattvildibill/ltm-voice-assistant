<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Life Story Voice Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #060910;
      --bg-2: #0c1222;
      --panel: #0f1729;
      --panel-2: #131d33;
      --muted: #9fb2d7;
      --text: #eaf0ff;
      --accent: #6cf0c2;
      --accent-2: #7aa8ff;
      --border: #1b2945;
      --border-2: #203356;
      --shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Helvetica Neue", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(108, 240, 194, 0.05), transparent 32%),
                  radial-gradient(circle at 80% 0%, rgba(122, 168, 255, 0.08), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 26px;
      position: relative;
    }

    .page {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 60px auto;
    }

    .bg-grid {
      pointer-events: none;
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      opacity: 0.4;
      z-index: 0;
    }

    h1, h2, h3, h4 { margin: 0; letter-spacing: 0.4px; }
    p { margin: 0; color: var(--muted); line-height: 1.6; }
    .muted { color: var(--muted); }
    .small { font-size: 14px; }
    .eyebrow { text-transform: uppercase; letter-spacing: 1.6px; font-size: 12px; color: var(--accent-2); margin-bottom: 6px; }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 6;
      backdrop-filter: blur(12px);
    }
    .top-bar .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.6px;
    }
    .nav-links {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .nav-links a:hover {
      color: var(--text);
      border-color: var(--border);
      background: rgba(255, 255, 255, 0.04);
    }
    .nav-cta {
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #041023;
      font-weight: 700;
      text-decoration: none;
    }

    .hero {
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
      background: linear-gradient(140deg, rgba(16, 27, 53, 0.9), rgba(12, 16, 30, 0.95));
      border-radius: 18px;
      padding: 26px;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.9fr);
      gap: 18px;
      align-items: start;
    }
    .hero-top {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 8px;
    }

    .brand-mark {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: #051021;
      font-weight: 700;
      letter-spacing: 1px;
      box-shadow: 0 6px 30px rgba(108, 240, 194, 0.3);
    }

    .hero h1 { font-size: 30px; margin-bottom: 6px; }
    .hero p { max-width: 840px; }
    .hero-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .hero-actions a {
      text-decoration: none;
    }
    .hero-actions .secondary {
      border: 1px solid var(--border-2);
      background: rgba(255, 255, 255, 0.02);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .hero-actions .primary-link {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #041023;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      color: #e6ecff;
      font-size: 13px;
    }
    .chip .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 4px rgba(108, 240, 194, 0.12); }

    .hero-panels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 18px;
    }
    .hero-card {
      border: 1px solid var(--border);
      background: rgba(12, 18, 34, 0.8);
      border-radius: var(--radius);
      padding: 14px;
    }
    .hero-card h4 { margin-bottom: 6px; font-size: 16px; }

    .access-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .access-field {
      border: 1px solid var(--border);
      background: rgba(12, 18, 34, 0.75);
      border-radius: 12px;
      padding: 12px;
    }
    .access-field label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .access-field input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
      background: #0b1222;
      color: #eaf0ff;
      font-family: "Space Grotesk", "Helvetica Neue", sans-serif;
    }

    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      position: sticky;
      top: 12px;
      z-index: 5;
      margin: 22px 0 14px;
    }
    .tab-btn {
      padding: 12px 18px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      color: #e2e9ff;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .tab-btn:hover { border-color: var(--border-2); }
    .tab-btn.active {
      background: linear-gradient(135deg, #12203a, #0e1c33);
      border-color: var(--accent-2);
      box-shadow: 0 6px 24px rgba(122, 168, 255, 0.2);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
    }
    .capture-grid { grid-template-columns: 1.1fr 0.9fr; }
    .insights-grid { grid-template-columns: 1.1fr 0.9fr; }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
    }
    .card h2 { margin-bottom: 6px; }
    .card h3 { margin: 0; }
    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-2);
      background: rgba(108, 240, 194, 0.08);
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
    }

    button {
      padding: 11px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: #f8fbff;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
      transition: all 0.2s ease;
    }
    button:hover:not([disabled]) { border-color: var(--border-2); transform: translateY(-1px); }
    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: transparent;
      color: #041023;
      box-shadow: 0 8px 30px rgba(108, 240, 194, 0.25);
    }
    button[disabled] { opacity: 0.6; cursor: default; transform: none; box-shadow: none; }

    .user-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .auth-card {
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px;
      background: rgba(8, 14, 26, 0.8);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }
    .auth-card .user-input { margin-bottom: 8px; }
    .auth-card .controls { justify-content: space-between; }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }
    .status-line { margin: 4px 0 10px; color: var(--muted); font-style: italic; }
    #log {
      white-space: pre-wrap;
      font-size: 14px;
      background: #0b101d;
      padding: 12px;
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      color: #cfdaf4;
    }
    .log-wrap { margin-top: 8px; }

    .callouts { display: grid; gap: 8px; margin-top: 10px; }
    .callout {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px dashed var(--border-2);
      border-radius: 12px;
      font-size: 14px;
      color: #d5dffa;
    }
    .prompt-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed var(--border-2);
      background: rgba(108, 240, 194, 0.06);
    }
    .prompt-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
    .prompt-text { margin-top: 6px; color: #eaf4ff; line-height: 1.5; }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      background: rgba(122, 168, 255, 0.12);
      border: 1px solid var(--border-2);
      color: #e8edff;
      border-radius: 999px;
      margin: 0 6px 6px 0;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
    }
    .badge.positive { background: rgba(108, 240, 194, 0.12); color: var(--accent); border-color: rgba(108, 240, 194, 0.3); }
    .badge.neutral { background: rgba(255, 255, 255, 0.04); color: #dbe6ff; border-color: var(--border); }
    .badge.negative { background: rgba(255, 123, 123, 0.12); color: #ffb4b4; border-color: rgba(255, 123, 123, 0.3); }

    .entry-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: var(--panel-2);
      margin-bottom: 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
    }
    .entry-header { display: flex; justify-content: space-between; gap: 8px; align-items: baseline; }
    .entry-body { margin-top: 8px; color: #dbe6ff; }
    .entry-meta { font-size: 13px; color: var(--muted); line-height: 1.5; }
    .expand { cursor: pointer; color: var(--accent); font-size: 13px; margin-top: 6px; display: inline-block; }
    .trust-row { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0 6px; }
    .entry-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .entry-edit { margin-top: 10px; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.02); }
    .entry-edit label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-top: 10px; }
    .entry-edit input,
    .entry-edit select,
    .entry-edit textarea {
      width: 100%;
      margin-top: 6px;
      background: #0c1325;
      color: #eaefff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      font-family: "Space Grotesk", "Helvetica Neue", sans-serif;
    }
    .entry-edit .row { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .entry-edit .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .flag-pill { background: rgba(255, 123, 123, 0.12); color: #ffb4b4; border: 1px solid rgba(255, 123, 123, 0.3); }
    .entry-status { margin-top: 8px; font-size: 12px; color: var(--muted); }

    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; margin: 6px 0 12px; }
    .filter-btn { background: rgba(255, 255, 255, 0.03); }
    .filter-btn.active { background: rgba(108, 240, 194, 0.16); color: #042013; border-color: var(--accent); box-shadow: 0 6px 18px rgba(108, 240, 194, 0.2); }

    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 10px; margin: 10px 0; }
    .stat { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .stat strong { display: block; margin-bottom: 4px; }
    .chart { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    .sparkline { width: 100%; height: 90px; background: #0f1524; border: 1px solid var(--border-2); border-radius: 12px; padding: 8px; }
    .recap-card { border: 1px solid var(--border-2); border-radius: 12px; padding: 12px; background: rgba(122, 168, 255, 0.06); margin-top: 10px; }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .section-note {
      font-size: 13px;
      color: var(--muted);
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 18px 0;
      opacity: 0.6;
    }
    footer {
      margin-top: 32px;
      padding: 24px 0 10px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }
    .video-card { border: 1px solid var(--border-2); border-radius: 12px; padding: 12px; background: rgba(108, 240, 194, 0.08); margin-top: 12px; }
    .video-player { width: 100%; border-radius: 12px; border: 1px solid var(--border); margin-top: 10px; background: #0b1222; }
    .download-link { display: inline-block; margin-top: 8px; color: var(--accent); text-decoration: none; }
    .download-link:hover { text-decoration: underline; }

    .chat-pane {
      background: #0d1220;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      max-height: 360px;
      min-height: 280px;
      overflow-y: auto;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
    }
    .bubble {
      max-width: 90%;
      padding: 10px 12px;
      border-radius: 12px;
      margin: 8px 0;
      line-height: 1.5;
      font-size: 15px;
      position: relative;
    }
    .bubble.user { background: linear-gradient(135deg, #12243f, #0f1f34); margin-left: auto; color: #e8f1ff; }
    .bubble.assistant { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); color: #e4eaf5; }
    .bubble-meta { font-size: 12px; color: var(--muted); margin-top: -2px; margin-bottom: 10px; }
    .chat-input { display: flex; gap: 10px; margin-top: 10px; }
    .chat-input textarea { flex: 1; min-height: 80px; background: #0c1325; color: #eaefff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; resize: vertical; }

    textarea { width: 100%; }
    .hidden { display: none; }

    @media (max-width: 900px) {
      body { padding: 18px; }
      .top-bar { position: static; }
      .capture-grid, .insights-grid { grid-template-columns: 1fr; }
      .hero-grid { grid-template-columns: 1fr; }
      .chat-pane { min-height: 220px; }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <main class="page">
    <header class="top-bar">
      <div class="brand">
        <div class="brand-mark">LS</div>
        <span>Life Story</span>
      </div>
      <nav class="nav-links">
        <a href="#capture">Capture</a>
        <a href="#timeline">Timeline</a>
        <a href="#insights">Insights</a>
        <a href="#privacy">Privacy</a>
        <a class="nav-cta" href="#capture">Start journaling</a>
      </nav>
    </header>
    <section class="hero">
      <div class="hero-grid">
        <div>
          <div class="hero-top">
            <div class="brand-mark">LS</div>
            <div>
              <div class="eyebrow">Life Story Voice Assistant</div>
              <h1>Your private memory companion, now ready for everyday use</h1>
              <p>Capture stories in seconds, keep an auditable timeline, and ask questions answered using only the entries you‚Äôve stored.</p>
              <div class="hero-actions">
                <a class="primary-link" href="#capture">Start your first entry</a>
                <a class="secondary" href="#insights">View insights</a>
              </div>
            </div>
          </div>
          <div class="chip-row">
            <span class="chip"><span class="dot"></span> Records & transcribes audio</span>
            <span class="chip">Summaries, sentiment, topics & people/places</span>
            <span class="chip">Account-secured memory vault</span>
            <span class="chip">Retrieval-grounded chat + weekly recap</span>
          </div>
          <div class="hero-panels">
            <div class="hero-card">
              <h4>Capture workflow</h4>
              <p>Start/stop recording, auto-upload to the backend, and keep the log visible so you always know what happened.</p>
            </div>
            <div class="hero-card">
              <h4>Timeline filters</h4>
              <p>Browse entries by last 7 days, 30 days, or all time with sentiment, topics, and expandable detail.</p>
            </div>
            <div class="hero-card">
              <h4>Insights & chat</h4>
              <p>View basic stats, see recency trends, and chat with an assistant that cites the entries it used.</p>
            </div>
          </div>
        </div>
        <div>
          <div class="eyebrow">Account</div>
          <div class="auth-card">
            <input id="authEmail" class="user-input" type="email" placeholder="email@domain.com" />
            <input id="authPassword" class="user-input" type="password" placeholder="password (min 8 chars)" />
            <div class="controls" style="margin-top: 8px;">
              <button id="signupBtn" class="primary">Sign up</button>
              <button id="loginBtn">Log in</button>
              <button id="logoutBtn">Log out</button>
            </div>
            <div id="authStatus" class="muted small" style="margin-top: 6px;">Create an account or log in to sync your memories.</div>
          </div>
          <div class="divider"></div>
          <div class="hero-card">
            <h4>Privacy-first by default</h4>
            <p>Your entries are scoped to your account. We only answer using the memories you‚Äôve stored.</p>
          </div>
          <div class="hero-card" style="margin-top: 10px;">
            <h4>Quick start checklist</h4>
            <p>1. Sign up ‚Ä¢ 2. Record a memory ‚Ä¢ 3. Ask the chat a question ‚Ä¢ 4. Review your weekly recap</p>
          </div>
        </div>
      </div>
    </section>

    <div class="tabs">
      <button class="tab-btn active" data-tab="capture">Capture</button>
      <button class="tab-btn" data-tab="timeline">Timeline</button>
      <button class="tab-btn" data-tab="insights">Insights &amp; Chat</button>
    </div>

    <!-- Capture Tab -->
    <section id="capture" class="tab-content active">
      <div class="section-grid capture-grid">
        <div class="card">
          <div class="card-header">
            <div class="section-title">
              <div>
              <div class="eyebrow">Voice to memory</div>
              <h2>Record or upload an entry</h2>
              <p>Click start, tell your story, then save. Audio is transcribed, summarized, and stored with sentiment and topics.</p>
              </div>
              <div class="section-note">Securely saved to your account</div>
            </div>
            <div class="status-pill">Live capture</div>
          </div>
          <div class="controls">
            <button id="startBtn" class="primary">üé§ Start Recording</button>
            <button id="stopBtn">üõë Stop &amp; Save</button>
          </div>
          <div id="status" class="status-line">Not recording.</div>
          <div class="log-wrap">
            <div class="small muted" style="margin-bottom:6px;">Activity log</div>
            <div id="log"></div>
          </div>
          <div class="callouts">
            <div class="callout">Uploads to <code>/entries</code> (or your configured API base) and refreshes your timeline automatically.</div>
            <div class="callout">Summaries, topics, and people/places are displayed in the timeline cards.</div>
            <div class="callout">Use the Insights tab for stats, weekly recaps, and retrieval-grounded chat.</div>
          </div>
          <div class="prompt-box">
            <div class="prompt-header">
              <div>
                <div class="eyebrow" style="margin-bottom:2px;">Need a prompt?</div>
                <div class="small muted">Ask for a tailored question, then answer it by recording or via chat.</div>
              </div>
              <div class="controls" style="margin:0;">
                <button id="promptBtn" class="primary">Request a prompt</button>
                <button id="promptUseBtn">Send to chat</button>
              </div>
            </div>
            <div id="promptText" class="prompt-text muted">Press ‚ÄúRequest a prompt‚Äù to generate a personal question based on your recent entries.</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="section-title">
              <div>
              <div class="eyebrow">Latest saves</div>
              <h3>Recent entries</h3>
              </div>
              <div class="section-note">Synced across sessions</div>
            </div>
          </div>
          <div id="recentEntries" class="muted">Loading‚Ä¶</div>
        </div>
      </div>
    </section>

    <!-- Timeline Tab -->
    <section id="timeline" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <div>
            <div class="eyebrow">Browse</div>
            <h2>Timeline</h2>
            <p class="small">Filter by recency to scan summaries, sentiment, topics, and full text in one view.</p>
            </div>
            <div class="section-note">Searchable memory history</div>
          </div>
        </div>
        <div class="filter-row">
          <button class="filter-btn" data-range="7" id="filter7">Last 7 days</button>
          <button class="filter-btn" data-range="30" id="filter30">Last 30 days</button>
          <button class="filter-btn active" data-range="all" id="filterAll">All time</button>
        </div>
        <div id="timelineStatus" class="muted">Loading‚Ä¶</div>
        <div id="timelineList"></div>
      </div>
    </section>

    <!-- Insights & Chat Tab -->
    <section id="insights" class="tab-content">
      <div class="section-grid insights-grid">
        <div class="card">
          <div class="card-header">
            <div class="section-title">
              <div>
              <div class="eyebrow">Summary &amp; trends</div>
              <h2>Insights</h2>
              </div>
              <div class="section-note">Weekly and monthly rollups</div>
            </div>
          </div>
          <p id="summaryText" class="muted">Loading stats‚Ä¶</p>
          <div class="stat-grid">
            <div class="stat" id="statEntries"></div>
            <div class="stat" id="statWords"></div>
            <div class="stat" id="statAvg"></div>
          </div>
          <div id="entriesChart" class="chart"></div>
          <div class="recap-card">
            <div class="card-header" style="margin-bottom:4px;">
              <div>
                <div class="eyebrow">Weekly pulse</div>
                <h3 style="margin:0;">Generate recap</h3>
              </div>
              <button id="weeklyQuickBtn" class="primary">Generate</button>
            </div>
            <div id="weeklyQuickStatus" class="muted small"></div>
            <div id="weeklyQuickResult" class="recap-card hidden" style="margin:0;"></div>
          </div>
          <div class="video-card">
            <div class="card-header" style="margin-bottom:4px;">
              <div>
                <div class="eyebrow">Weekly video</div>
                <h3 style="margin:0;">30s recap</h3>
                <p class="small muted">AI-generated flat pastel cartoon scenes with a neutral voice. Generated on demand.</p>
              </div>
              <button id="weeklyVideoBtn" class="primary">Generate video</button>
            </div>
            <div id="weeklyVideoStatus" class="muted small"></div>
            <video id="weeklyVideoPlayer" class="video-player hidden" controls playsinline></video>
            <a id="weeklyVideoDownload" class="download-link hidden">Download MP4</a>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="section-title">
              <div>
              <div class="eyebrow">Retrieval-grounded chat</div>
              <h2>Chat with your memories</h2>
              <p class="small muted">The assistant answers using only your stored entries and shows how many it used.</p>
              </div>
              <div class="section-note">Grounded answers only</div>
            </div>
          </div>
          <div id="chatPane" class="chat-pane"></div>
          <div class="chat-input">
            <textarea id="chatInput" placeholder="Ask something about your memories..."></textarea>
            <button id="chatSendBtn" class="primary">Send</button>
          </div>
          <div class="muted small" id="chatStatus"></div>
        </div>
      </div>
    </section>
  </main>
  <footer id="privacy">
    <div>Private by design ‚Ä¢ Account-scoped memories ‚Ä¢ You control what you save</div>
    <div style="margin-top:6px;">Life Story Voice Assistant ¬© 2025</div>
  </footer>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const userIdInput = document.getElementById("userIdInput");
    const apiKeyInput = document.getElementById("apiKeyInput");
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");
    const recentEntriesEl = document.getElementById("recentEntries");
    const timelineStatus = document.getElementById("timelineStatus");
    const timelineList = document.getElementById("timelineList");
    const summaryText = document.getElementById("summaryText");
    const entriesChart = document.getElementById("entriesChart");
    const statEntries = document.getElementById("statEntries");
    const statWords = document.getElementById("statWords");
    const statAvg = document.getElementById("statAvg");
    const weeklyQuickBtn = document.getElementById("weeklyQuickBtn");
    const weeklyQuickStatus = document.getElementById("weeklyQuickStatus");
    const weeklyQuickResult = document.getElementById("weeklyQuickResult");
    const weeklyVideoBtn = document.getElementById("weeklyVideoBtn");
    const weeklyVideoStatus = document.getElementById("weeklyVideoStatus");
    const weeklyVideoPlayer = document.getElementById("weeklyVideoPlayer");
    const weeklyVideoDownload = document.getElementById("weeklyVideoDownload");
    const chatPane = document.getElementById("chatPane");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatStatus = document.getElementById("chatStatus");
    const promptBtn = document.getElementById("promptBtn");
    const promptUseBtn = document.getElementById("promptUseBtn");
    const promptText = document.getElementById("promptText");

    const filter7 = document.getElementById("filter7");
    const filter30 = document.getElementById("filter30");
    const filterAll = document.getElementById("filterAll");

    let mediaRecorder = null;
    let chunks = [];
    let conversationHistory = [];
    let entriesCache = [];
    let summaryCache = null;
    let weeklyVideoBlobUrl = null;
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const signupBtn = document.getElementById("signupBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");

    const AUTH_TOKEN_KEY = "ltm-auth-token";
    const AUTH_EMAIL_KEY = "ltm-auth-email";
    const API_BASE = window.LTM_API_BASE || "";

    const savedEmail = localStorage.getItem(AUTH_EMAIL_KEY);
    if (savedEmail) {
      authEmail.value = savedEmail;
    }

    function getAuthToken() {
      return localStorage.getItem(AUTH_TOKEN_KEY);
    }

    function setAuthToken(token, email) {
      if (token) {
        localStorage.setItem(AUTH_TOKEN_KEY, token);
      } else {
        localStorage.removeItem(AUTH_TOKEN_KEY);
      }
      if (email) {
        localStorage.setItem(AUTH_EMAIL_KEY, email);
      }
    }

    function fetchWithAuth(url, options = {}) {
      const headers = new Headers(options.headers || {});
      const token = getAuthToken();
      if (token) {
        headers.set("Authorization", `Bearer ${token}`);
      }
      return fetch(url, { ...options, headers });
    }

    function resetUserScopedState() {
      entriesCache = [];
      summaryCache = null;
      conversationHistory = [];
      renderConversation();
      chatStatus.textContent = "";
      if (weeklyVideoBlobUrl) {
        URL.revokeObjectURL(weeklyVideoBlobUrl);
        weeklyVideoBlobUrl = null;
      }
      weeklyVideoPlayer.classList.add("hidden");
      weeklyVideoPlayer.removeAttribute("src");
      weeklyVideoDownload.classList.add("hidden");
      weeklyVideoStatus.textContent = "";
      loadEntries();
      loadSummary();
    }

    function setAuthStatus(message, isError = false) {
      authStatus.textContent = message;
      authStatus.style.color = isError ? "#ff9b9b" : "";
    }

    async function signup() {
      const email = (authEmail.value || "").trim();
      const password = (authPassword.value || "").trim();
      if (!email || !password) {
        setAuthStatus("Enter email and password to sign up.", true);
        return;
      }
      try {
        const resp = await fetch(`${API_BASE}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          setAuthStatus(`Signup failed: ${text}`, true);
          return;
        }
        const data = await resp.json();
        setAuthToken(data.access_token, email);
        setAuthStatus(`Signed in as ${email}.`);
        resetUserScopedState();
      } catch (err) {
        setAuthStatus(`Signup error: ${err}`, true);
      }
    }

    async function login() {
      const email = (authEmail.value || "").trim();
      const password = (authPassword.value || "").trim();
      if (!email || !password) {
        setAuthStatus("Enter email and password to log in.", true);
        return;
      }
      try {
        const resp = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          setAuthStatus(`Login failed: ${text}`, true);
          return;
        }
        const data = await resp.json();
        setAuthToken(data.access_token, email);
        setAuthStatus(`Signed in as ${email}.`);
        resetUserScopedState();
      } catch (err) {
        setAuthStatus(`Login error: ${err}`, true);
      }
    }

    function logout() {
      setAuthToken(null, null);
      setAuthStatus("Logged out.");
      resetUserScopedState();
    }

    signupBtn.addEventListener("click", signup);
    loginBtn.addEventListener("click", login);
    logoutBtn.addEventListener("click", logout);

    if (getAuthToken() && savedEmail) {
      setAuthStatus(`Signed in as ${savedEmail}.`);
    }

    function ensureAuthenticated(message) {
      if (getAuthToken()) {
        return true;
      }
      setAuthStatus(message || "Please sign up or log in to continue.", true);
      return false;
    }

    function getActiveRange() {
      const active = document.querySelector(".filter-btn.active");
      return active ? active.dataset.range : "all";
    }

    function formatDate(value) {
      if (!value) return "‚Äî";
      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime()) ? "‚Äî" : parsed.toLocaleString();
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return "‚Äî";
      const num = Number(value);
      return Number.isNaN(num) ? "‚Äî" : `${Math.round(num * 100)}%`;
    }

    function joinList(values) {
      return values && values.length ? values.join(", ") : "‚Äî";
    }

    function parseCommaList(value) {
      if (!value) return [];
      return value.split(",").map((item) => item.trim()).filter(Boolean);
    }

    // --- Tab logic ---
    function setActiveTab(tabName) {
      tabButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.tab === tabName));
      tabContents.forEach((section) => section.classList.toggle("active", section.id === tabName));

      if (tabName === "timeline" || tabName === "capture" || tabName === "insights") {
        loadEntries(); // shared cache
      }
      if (tabName === "insights") {
        loadSummary();
      }
    }
    tabButtons.forEach((btn) => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));

    // --- Capture (existing flow) ---
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function startRecording() {
      if (!ensureAuthenticated("Log in to record and save entries.")) {
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          log("Recording stopped. Uploading entry to backend‚Ä¶");
          statusEl.textContent = "Uploading and processing entry‚Ä¶";
          const formData = new FormData();
          formData.append("file", blob, "entry.webm");

          try {
            const resp = await fetchWithAuth(`${API_BASE}/entries`, { method: "POST", body: formData });
            if (!resp.ok) {
              const text = await resp.text();
              log(`‚ùå Server error: ${resp.status} ‚Äì ${text}`);
              statusEl.textContent = "Error uploading entry.";
              return;
            }
            await resp.json();
            log("‚úÖ Entry stored. Analysis running in the background.");
            statusEl.textContent = "Entry saved. Analysis in progress.";
            entriesCache = []; // force reload
            loadEntries();
            loadSummary();
          } catch (err) {
            console.error(err);
            log("‚ùå Failed to upload entry: " + err.message);
            statusEl.textContent = "Upload failed.";
          }
        };

        mediaRecorder.start();
        statusEl.textContent = "Recording‚Ä¶ tell your story.";
        log("üéô Recording started.");
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error(err);
        log("‚ùå Could not start recording: " + err.message);
        statusEl.textContent = "Microphone access failed.";
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }
    startBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);

    // --- Data fetching ---
    async function loadEntries() {
      if (!ensureAuthenticated("Log in to view entries.")) {
        recentEntriesEl.textContent = "Log in to load your entries.";
        timelineStatus.textContent = "Log in to load your entries.";
        return;
      }
      if (entriesCache.length) {
        renderRecent(entriesCache);
        renderTimeline(entriesCache, getActiveRange());
        return;
      }
      timelineStatus.textContent = "Loading‚Ä¶";
      try {
        const resp = await fetchWithAuth(`${API_BASE}/insights/entries`);
        if (!resp.ok) throw new Error(`Server responded with ${resp.status}`);
        entriesCache = await resp.json();
        renderRecent(entriesCache);
        renderTimeline(entriesCache, getActiveRange());
      } catch (err) {
        recentEntriesEl.textContent = `Failed to load entries: ${err.message}`;
        timelineStatus.textContent = `Failed to load entries: ${err.message}`;
      }
    }

    async function loadSummary() {
      if (!ensureAuthenticated("Log in to view insights.")) {
        summaryText.textContent = "Log in to view your insights.";
        entriesChart.innerHTML = "";
        return;
      }
      if (summaryCache) {
        renderSummary(summaryCache);
        return;
      }
      summaryText.textContent = "Loading stats‚Ä¶";
      entriesChart.innerHTML = "";
      try {
        const resp = await fetchWithAuth(`${API_BASE}/insights/summary`);
        if (!resp.ok) throw new Error(`Server responded with ${resp.status}`);
        summaryCache = await resp.json();
        renderSummary(summaryCache);
      } catch (err) {
        summaryText.textContent = `Failed to load stats: ${err.message}`;
      }
    }

    async function updateEntry(entryId, payload, statusEl) {
      statusEl.textContent = "Saving changes‚Ä¶";
      try {
        const resp = await fetchWithAuth(`${API_BASE}/entries/${entryId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        entriesCache = [];
        summaryCache = null;
        await loadEntries();
        statusEl.textContent = "Saved.";
        return true;
      } catch (err) {
        statusEl.textContent = `Save failed: ${err.message}`;
        return false;
      }
    }

    async function confirmEntry(entryId, statusEl) {
      statusEl.textContent = "Confirming‚Ä¶";
      try {
        const resp = await fetchWithAuth(`${API_BASE}/entries/${entryId}/confirm`, {
          method: "POST",
        });
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        entriesCache = [];
        await loadEntries();
        statusEl.textContent = "Confirmed.";
      } catch (err) {
        statusEl.textContent = `Confirm failed: ${err.message}`;
      }
    }

    async function flagEntry(entryId, reason, statusEl, flagged = true) {
      statusEl.textContent = flagged ? "Flagging‚Ä¶" : "Removing flag‚Ä¶";
      try {
        const resp = await fetchWithAuth(`${API_BASE}/entries/${entryId}/flag`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ flagged, reason }),
        });
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        entriesCache = [];
        await loadEntries();
        statusEl.textContent = flagged ? "Flagged." : "Flag removed.";
      } catch (err) {
        statusEl.textContent = `Flag update failed: ${err.message}`;
      }
    }

    // --- Recent entries (Capture tab) ---
    function renderRecent(entries) {
      if (!entries || !entries.length) {
        recentEntriesEl.textContent = "No entries yet.";
        return;
      }
      const topThree = entries.slice(0, 3);
      recentEntriesEl.innerHTML = topThree.map((e) => {
        const date = new Date(e.created_at).toLocaleString();
        const status = e.processing_status || "complete";
        const statusLine = status === "pending"
          ? `<div class="small muted">Processing‚Ä¶</div>`
          : status === "failed"
            ? `<div class="small muted">Processing failed</div>`
            : "";
        return `<div class="entry-card"><div class="entry-header"><div>${date}</div></div><div class="entry-body">${e.summary || e.preview || "‚Äî"}${statusLine}</div></div>`;
      }).join("");
    }

    // --- Timeline ---
    [filter7, filter30, filterAll].forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        renderTimeline(entriesCache, btn.dataset.range || "all");
      });
    });

    function renderTimeline(entries, range = "all") {
      timelineList.innerHTML = "";
      if (!entries || !entries.length) {
        timelineStatus.textContent = "No entries yet.";
        return;
      }
      timelineStatus.textContent = "";
      const now = Date.now();
      const filtered = entries.filter((e) => {
        if (range === "all") return true;
        const days = parseInt(range, 10);
        const diff = (now - new Date(e.created_at).getTime()) / (1000 * 60 * 60 * 24);
        return diff <= days;
      });

      if (!filtered.length) {
        timelineStatus.textContent = "No entries in this range.";
        return;
      }

      filtered.forEach((entry) => {
        const card = document.createElement("div");
        card.className = "entry-card";
        const dateStr = new Date(entry.created_at).toLocaleString();
        const sentimentClass = entry.sentiment_label ? entry.sentiment_label.toLowerCase() : "neutral";
        const sentimentBadge = entry.sentiment_label
          ? `<span class="badge ${sentimentClass}">${entry.sentiment_label}${entry.sentiment_score ? ` (${Math.round(entry.sentiment_score * 100)}%)` : ""}</span>`
          : "";
        const processingStatus = entry.processing_status || "complete";
        const processingBadge = processingStatus === "pending"
          ? '<span class="badge neutral">Processing‚Ä¶</span>'
          : processingStatus === "failed"
            ? '<span class="badge negative">Processing failed</span>'
            : "";
        const memoryType = entry.memory_type || "event";
        const options = ["event", "reflection", "preference", "identity", "project"];
        const optionsHtml = options.map((opt) => `<option value="${opt}" ${opt === memoryType ? "selected" : ""}>${opt}</option>`).join("");
        const topicsHtml = (entry.topics || []).map((t) => `<span class="pill">${t}</span>`).join("") || '<span class="muted">No topics</span>';
        const titleLine = entry.title ? `<div class="small muted">${entry.title}</div>` : "";
        const fullText = entry.content || entry.preview || "‚Äî";
        const flaggedPill = entry.is_flagged
          ? `<span class="pill flag-pill">Flagged${entry.flagged_reason ? `: ${entry.flagged_reason}` : ""}</span>`
          : "";

        card.innerHTML = `
          <div class="entry-header">
            <div><strong>${dateStr}</strong>${titleLine}</div>
            <div>${sentimentBadge} ${processingBadge}</div>
          </div>
          <div class="entry-body">
            <div>${entry.summary || entry.preview || "‚Äî"}</div>
            <div style="margin-top:6px;">${topicsHtml}</div>
            <div class="expand" data-entry="${entry.id}">Toggle details</div>
            <div class="entry-meta hidden" id="meta-${entry.id}">
              <div class="trust-row">
                <span class="pill">Confidence: ${formatPercent(entry.confidence_score)}</span>
                <span class="pill">Confirmed: ${formatDate(entry.last_confirmed_at)}</span>
                <span class="pill">Updated: ${formatDate(entry.updated_at)}</span>
                ${flaggedPill}
              </div>
              <div><strong>Memory type:</strong> ${memoryType}</div>
              <div><strong>Full text:</strong> ${fullText}</div>
              <div><strong>People/Places:</strong> ${joinList(entry.people)} / ${joinList(entry.places)}</div>
              <div><strong>Tags:</strong> ${joinList(entry.tags)}</div>
              <div><strong>Word count:</strong> ${entry.word_count ?? "-"}</div>
              ${processingStatus !== "complete"
                ? `<div><strong>Processing:</strong> ${processingStatus}${entry.processing_error ? ` ‚Äî ${entry.processing_error}` : ""}</div>`
                : ""}
              <div class="entry-actions">
                <button class="edit-btn" data-entry="${entry.id}">Edit</button>
                <button class="confirm-btn primary" data-entry="${entry.id}">Confirm memory</button>
                <button class="flag-btn" data-entry="${entry.id}">${entry.is_flagged ? "Unflag" : "Flag as incorrect"}</button>
              </div>
              <div class="entry-edit hidden" id="edit-${entry.id}">
                <div class="row">
                  <div>
                    <label>Title</label>
                    <input type="text" name="title" />
                  </div>
                  <div>
                    <label>Memory type</label>
                    <select name="memory_type">
                      ${optionsHtml}
                    </select>
                  </div>
                </div>
                <label>Summary</label>
                <textarea name="summary" rows="2"></textarea>
                <label>Text</label>
                <textarea name="content" rows="4"></textarea>
                <div class="row">
                  <div>
                    <label>Tags (comma separated)</label>
                    <input type="text" name="tags" />
                  </div>
                  <div>
                    <label>People (comma separated)</label>
                    <input type="text" name="people" />
                  </div>
                  <div>
                    <label>Places (comma separated)</label>
                    <input type="text" name="places" />
                  </div>
                </div>
                <div class="actions">
                  <button class="save-btn primary" data-entry="${entry.id}">Save</button>
                  <button class="cancel-btn" data-entry="${entry.id}">Cancel</button>
                </div>
              </div>
              <div class="entry-status" id="status-${entry.id}"></div>
            </div>
          </div>
        `;

        const meta = card.querySelector(`#meta-${entry.id}`);
        const editForm = card.querySelector(`#edit-${entry.id}`);
        const statusEl = card.querySelector(`#status-${entry.id}`);

        const titleInput = editForm.querySelector('input[name="title"]');
        const memorySelect = editForm.querySelector('select[name="memory_type"]');
        const summaryInput = editForm.querySelector('textarea[name="summary"]');
        const contentInput = editForm.querySelector('textarea[name="content"]');
        const tagsInput = editForm.querySelector('input[name="tags"]');
        const peopleInput = editForm.querySelector('input[name="people"]');
        const placesInput = editForm.querySelector('input[name="places"]');

        titleInput.value = entry.title || "";
        memorySelect.value = memoryType;
        summaryInput.value = entry.summary || "";
        contentInput.value = entry.content || entry.preview || "";
        tagsInput.value = (entry.tags || []).join(", ");
        peopleInput.value = (entry.people || []).join(", ");
        placesInput.value = (entry.places || []).join(", ");

        card.querySelector(".expand").addEventListener("click", () => {
          meta.classList.toggle("hidden");
        });

        card.querySelector(".edit-btn").addEventListener("click", () => {
          editForm.classList.toggle("hidden");
          statusEl.textContent = "";
        });

        card.querySelector(".cancel-btn").addEventListener("click", () => {
          editForm.classList.add("hidden");
          statusEl.textContent = "";
        });

        card.querySelector(".save-btn").addEventListener("click", async () => {
          const payload = {
            title: titleInput.value.trim(),
            summary: summaryInput.value.trim(),
            content: contentInput.value.trim(),
            tags: parseCommaList(tagsInput.value),
            people: parseCommaList(peopleInput.value),
            places: parseCommaList(placesInput.value),
            memory_type: memorySelect.value,
          };
          const ok = await updateEntry(entry.id, payload, statusEl);
          if (ok) {
            editForm.classList.add("hidden");
          }
        });

        card.querySelector(".confirm-btn").addEventListener("click", async () => {
          await confirmEntry(entry.id, statusEl);
        });

        card.querySelector(".flag-btn").addEventListener("click", async () => {
          if (entry.is_flagged) {
            if (!window.confirm("Remove the incorrect flag for this memory?")) return;
            await flagEntry(entry.id, null, statusEl, false);
            return;
          }
          const reason = window.prompt("Why is this memory incorrect or low-confidence?");
          if (reason === null) return;
          await flagEntry(entry.id, reason, statusEl, true);
        });

        timelineList.appendChild(card);
      });
    }

    // --- Insights summary & chart ---
    function renderSummary(data) {
      if (!data) {
        summaryText.textContent = "No data available.";
        return;
      }
      const { total_entries, total_words, average_word_count, entries_per_day } = data;
      summaryText.textContent = "Your entries at a glance:";
      statEntries.innerHTML = `<strong>Entries</strong>${total_entries}`;
      statWords.innerHTML = `<strong>Total words</strong>${total_words}`;
      statAvg.innerHTML = `<strong>Avg words/entry</strong>${average_word_count.toFixed(1)}`;

      entriesChart.innerHTML = "";
      const spark = renderSparkline(entries_per_day || []);
      entriesChart.appendChild(spark);
    }

    function renderSparkline(points) {
      const wrap = document.createElement("div");
      wrap.className = "sparkline";

      if (!points.length) {
        wrap.textContent = "No entries per-day data yet.";
        return wrap;
      }

      // Use last 30 days max to avoid massive charts
      const recent = points.slice(-30);
      const maxCount = Math.max(...recent.map((p) => p.count), 1);
      const width = 600;
      const height = 60;

      const svgParts = [];
      recent.forEach((p, idx) => {
        const x = (idx / Math.max(recent.length - 1, 1)) * width;
        const y = height - (p.count / maxCount) * height;
        svgParts.push({ x, y, count: p.count, date: p.date });
      });

      const pathD = svgParts.map((pt, i) => `${i === 0 ? "M" : "L"}${pt.x},${pt.y}`).join(" ");
      const circles = svgParts
        .map((pt) => `<circle cx="${pt.x}" cy="${pt.y}" r="3" fill="${pt.count === maxCount ? "#6cf0c2" : "#7aa8ff"}"><title>${pt.date}: ${pt.count}</title></circle>`)
        .join("");

      wrap.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%;height:60px;">
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#7aa8ff" />
              <stop offset="100%" stop-color="#6cf0c2" />
            </linearGradient>
          </defs>
          <path d="${pathD}" fill="none" stroke="url(#grad)" stroke-width="2" />
          ${circles}
        </svg>
        <div class="muted" style="font-size:12px;margin-top:4px;">Last ${recent.length} days ‚Ä¢ Peak: ${maxCount} entr${maxCount === 1 ? "y" : "ies"} in a day</div>
      `;
      return wrap;
    }

    // --- Weekly recap (simple card) ---
    async function generateWeeklyQuick() {
      if (!ensureAuthenticated("Log in to generate a recap.")) {
        return;
      }
      weeklyQuickStatus.textContent = "Generating...";
      weeklyQuickResult.classList.add("hidden");
      weeklyQuickResult.innerHTML = "";
      weeklyQuickBtn.disabled = true;
      try {
        const resp = await fetchWithAuth(`${API_BASE}/insights/weekly`);
        if (resp.status === 404) {
          weeklyQuickStatus.textContent = "Add at least one entry in the last 7 days to get a recap.";
          return;
        }
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        const data = await resp.json();
        const themes = (data.themes || []).map((t) => `<span class="pill">${t}</span>`).join("") || '<span class="muted small">‚Äî</span>';
        const highlights = (data.highlights || []).map((h) => `<div>‚Ä¢ ${h}</div>`).join("") || '<span class="muted small">‚Äî</span>';
        weeklyQuickResult.classList.remove("hidden");
        weeklyQuickResult.innerHTML = `
          <div class="muted small">Entries: ${data.total_entries ?? "‚Äî"} ‚Ä¢ Avg sentiment: ${data.average_sentiment ?? "‚Äî"}</div>
          <div style="margin-top:6px;"><strong>Summary:</strong> ${data.summary || "‚Äî"}</div>
          <div style="margin-top:6px;"><strong>Themes:</strong> ${themes}</div>
          <div style="margin-top:6px;"><strong>Highlights:</strong> ${highlights}</div>
          <div style="margin-top:6px;"><strong>Top topics:</strong> ${(data.top_topics || []).join(", ") || "‚Äî"}</div>
        `;
        weeklyQuickStatus.textContent = "";
      } catch (err) {
        weeklyQuickStatus.textContent = `Error: ${err.message || "Weekly recap unavailable"}`;
        // TODO: handle missing /insights/weekly endpoint or upstream failures more gracefully
      } finally {
        weeklyQuickBtn.disabled = false;
      }
    }
    weeklyQuickBtn.addEventListener("click", generateWeeklyQuick);

    // --- Weekly video ---
    async function generateWeeklyVideo() {
      weeklyVideoStatus.textContent = "Starting weekly video render...";
      weeklyVideoBtn.disabled = true;
      weeklyVideoPlayer.classList.add("hidden");
      weeklyVideoDownload.classList.add("hidden");
      if (weeklyVideoBlobUrl) {
        URL.revokeObjectURL(weeklyVideoBlobUrl);
        weeklyVideoBlobUrl = null;
      }
      try {
        if (!ensureAuthenticated("Log in to generate a weekly video.")) {
          return;
        }
        const resp = await fetchWithAuth(`${API_BASE}/products/weekly-video`, {
          method: "POST",
        });
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        const data = await resp.json();
        await pollWeeklyVideoStatus(data.job_id);
      } catch (err) {
        weeklyVideoStatus.textContent = `Error: ${err.message || "Unable to start video"}`;
      } finally {
        weeklyVideoBtn.disabled = false;
      }
    }

    async function pollWeeklyVideoStatus(jobId) {
      const maxAttempts = 60;
      for (let attempt = 0; attempt < maxAttempts; attempt += 1) {
        weeklyVideoStatus.textContent = `Rendering video... (${attempt + 1}/${maxAttempts})`;
        const resp = await fetchWithAuth(`${API_BASE}/products/${jobId}`);
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        const data = await resp.json();
        if (data.status === "complete") {
          await loadWeeklyVideo(jobId);
          weeklyVideoStatus.textContent = "Weekly video ready.";
          return;
        }
        if (data.status === "failed") {
          weeklyVideoStatus.textContent = `Failed: ${data.error || "Unknown error"}`;
          return;
        }
        await new Promise((resolve) => setTimeout(resolve, 2000));
      }
      weeklyVideoStatus.textContent = "Still rendering. Check back in a moment.";
    }

    async function loadWeeklyVideo(jobId) {
      const resp = await fetchWithAuth(`${API_BASE}/products/${jobId}/download`);
      if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
      const blob = await resp.blob();
      if (weeklyVideoBlobUrl) {
        URL.revokeObjectURL(weeklyVideoBlobUrl);
      }
      weeklyVideoBlobUrl = URL.createObjectURL(blob);
      weeklyVideoPlayer.src = weeklyVideoBlobUrl;
      weeklyVideoPlayer.classList.remove("hidden");
      weeklyVideoDownload.href = weeklyVideoBlobUrl;
      weeklyVideoDownload.download = `weekly-video-${jobId}.mp4`;
      weeklyVideoDownload.textContent = "Download MP4";
      weeklyVideoDownload.classList.remove("hidden");
    }

    weeklyVideoBtn.addEventListener("click", generateWeeklyVideo);

    // --- Prompt suggestion ---
    async function requestPrompt() {
      if (!ensureAuthenticated("Log in to request a prompt.")) {
        return;
      }
      promptText.textContent = "Generating a personal prompt...";
      promptText.classList.remove("muted");
      promptBtn.disabled = true;
      promptUseBtn.disabled = true;
      try {
        const resp = await fetchWithAuth(`${API_BASE}/insights/prompt`);
        if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
        const data = await resp.json();
        promptText.textContent = data.prompt || "No prompt generated.";
        chatInput.value = data.prompt || chatInput.value;
        chatStatus.textContent = data.note || "Prompt ready ‚Äî record or send via chat.";
      } catch (err) {
        promptText.textContent = `Unable to get a prompt: ${err.message}`;
      } finally {
        promptBtn.disabled = false;
        promptUseBtn.disabled = false;
      }
    }
    function usePromptInChat() {
      const text = promptText.textContent.trim();
      if (!text || text.startsWith("Press")) {
        chatStatus.textContent = "Generate a prompt first.";
        return;
      }
      chatInput.value = text;
      chatInput.focus();
      chatStatus.textContent = "Prompt loaded into chat. Edit and send when ready.";
    }
    promptBtn.addEventListener("click", requestPrompt);
    promptUseBtn.addEventListener("click", usePromptInChat);

    // --- Chat ---
    async function sendConversationMessage() {
      if (!ensureAuthenticated("Log in to chat with your memories.")) {
        return;
      }
      const text = chatInput.value.trim();
      if (!text) {
        chatStatus.textContent = "Please enter a message.";
        return;
      }
      chatStatus.textContent = "Thinking‚Ä¶";
      chatSendBtn.disabled = true;

      conversationHistory.push({ role: "user", content: text });
      renderConversation();
      chatInput.value = "";

      try {
        const resp = await fetchWithAuth(`${API_BASE}/conversation/respond`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: conversationHistory }),
        });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        conversationHistory.push({
          role: "assistant",
          content: data.response || "No response.",
          used_entry_ids: data.used_entry_ids || [],
        });
        renderConversation();
        chatStatus.textContent = data.used_entry_ids?.length
          ? `Based on ${data.used_entry_ids.length} entr${data.used_entry_ids.length === 1 ? "y" : "ies"}.`
          : "";
      } catch (err) {
        chatStatus.textContent = `Error: ${err.message}`;
      } finally {
        chatSendBtn.disabled = false;
      }
    }
    chatSendBtn.addEventListener("click", sendConversationMessage);

    function renderConversation() {
      chatPane.innerHTML = "";
      conversationHistory.forEach((turn) => {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${turn.role}`;
        bubble.textContent = turn.content;
        chatPane.appendChild(bubble);
        if (turn.role === "assistant" && turn.used_entry_ids && turn.used_entry_ids.length) {
          const meta = document.createElement("div");
          meta.className = "bubble-meta";
          meta.textContent = `Based on ${turn.used_entry_ids.length} entr${turn.used_entry_ids.length === 1 ? "y" : "ies"}.`;
          chatPane.appendChild(meta);
        }
      });
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    // Initial load
    setActiveTab("capture");
  </script>
</body>
</html>
